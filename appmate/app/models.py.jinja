from django.conf import settings
from django.db import models

from bitcoin.rpc import Proxy

__all__ = (
    {% for model in models %}
    '{{ model.name }}',
    {% endfor %}
)


class _UtilMixin(object):
    @classmethod
    def _fields(cls):
        return tuple(f.name for f in cls._meta.fields)

    def __str__(self):
        return 'id: {}'.format(self.id)
{% for model in models %}


class {{ model.name }}(_UtilMixin, models.Model):
    {% for field in model.fields %}
    {{ field.name }} = models.{{ field.type }}({{ field.args | default(field_arg[field.type]) }})
    {% endfor %}
    {% if model.name == 'Restaurant' %}

    @property
    def avg_point(self):
        qs = self.rate_set.all()
        n = len(qs)
        if not n :
            return 0
        return sum(rate.point for rate in qs) / n
    {% elif model.name == 'Rate' %}

    @property
    def thumbup(self):
        return self.thumbup_set.filter(check=True).count()
    {% elif model.name == 'User' %}

    @property
    def b_account(self):
        '''
        Bitcoin Account Address(es)

        This address is used for receiving payment.
        The account name is imei.
        '''
        id_ = str(self.id)
        try:
            rpc = Proxy(settings.BITCOIN_API)
            if id_ not in rpc._call('listaccounts'):
                rpc.getaccountaddress(id_)  # create if not exists
                ret = rpc._call('getaddressesbyaccount', id_)
                rpc._call('generatetoaddress', 10, ret[0])

            ret = rpc._call('getaddressesbyaccount', id_)
        except Exception as err:
            print(err)
            return None
        return ret
    {% endif %}
{% endfor %}
